---
# author: @tischrei
- module_defaults:
    nat_gateway:
      cloud: "{{ test_cloud }}"
    opentelekomcloud.cloud.floating_ip:
      cloud: "{{ test_cloud }}"
    openstack.cloud.server:
      cloud: "{{ test_cloud }}"
  block:
    - name: Set random prefix
      set_fact:
        # prefix: "{{ 99999999 | random | to_uuid | hash('md5') }}"
        prefix: test-prefix

    - name: Set initial facts
      set_fact:
        network_name: "{{ ( prefix + '_nat-network') }}"
        subnet_name: "{{ ( prefix + '_nat-subnet') }}"
        router_name: "{{ ( prefix + '_nat-router') }}"
        nat_gateway_name: "{{ ( prefix + '_nat-gateway') }}"
        server_name: "{{ ( prefix + '_nat-server') }}"
        server_image: c8983e9e-1dda-479a-9a95-b41fe325a703
        server_flavor: "s2.medium.2"


    - name: Create network for NAT
      os_network:
        name: "{{ network_name }}"
        state: present
      register: nat_net

    - name: Create subnet for NAT
      os_subnet:
        name: "{{ subnet_name }}"
        state: present
        network_name: "{{ nat_net.network.name }}"
        cidr: "192.168.110.0/24"
        dns_nameservers: "{{ ['100.125.4.25', '8.8.8.8'] }}"
      register: nat_subnet

    - name: Create Router for NAT
      os_router:
        name: "{{ router_name }}"
        state: present
        network: admin_external_net
        enable_snat: false
        interfaces:
          - net: "{{ nat_net.network.name }}"
            subnet: "{{ nat_subnet.subnet.name }}"
      register: nat_router

    - name: Create NAT gateway
      nat_gateway:
        name: "{{ nat_gateway_name }}"
        internal_network: "{{ network_name }}"
        router: "{{ router_name }}"
      register: nat_gw

    - name: Launch a server instance
      openstack.cloud.server:
        name: "{{ server_name }}"
        image: "{{ server_image }}"
        network: "{{ network_name }}"
        flavor: "{{ server_flavor }}"
        auto_ip: false
      register: server
    
    - name: assert result
      assert:
        that:
          - server is success
          - server.server.id is defined
