---
- module_defaults:
    opentelekomcloud.cloud.vpn_service:
      cloud: "{{ test_cloud }}"
  block:
    - name: Set random prefix
      set_fact:
        prefix: "{{ 99999999 | random | to_uuid | hash('md5') }}"

    - name: Set initial facts
      set_fact:
        network_name: "{{ ( prefix + 'vpn-test-network') }}"
        subnet_name_1: "{{ ( prefix + 'vpn-test-subnet-1') }}"
        subnet_name_2: "{{ ( prefix + 'vpn-test-subnet-2') }}"
        router_name: "{{ ( prefix + 'vpn-test-router') }}"
        vpn_name: "{{ ( prefix + 'vpn-test') }}"

    - name: Create network for test
      openstack.cloud.network:
        cloud: "{{ test_cloud }}"
        name: "{{ network_name }}"
        state: present
      register: test_network

    - name: Create first subnet for test
      openstack.cloud.subnet:
        cloud: "{{ test_cloud }}"
        name: "{{ subnet_name_1 }}"
        state: present
        network_name: "{{ test_network.network.name }}"
        cidr: "192.168.0.0/24"
        dns_nameservers: "{{ ['100.125.4.25', '8.8.8.8'] }}"
      register: test_subnet_1

    - name: Create second subnet for test
      openstack.cloud.subnet:
        cloud: "{{ test_cloud }}"
        name: "{{ subnet_name_2 }}"
        state: present
        network_name: "{{ test_network.network.name }}"
        cidr: "192.168.1.0/24"
        dns_nameservers: "{{ ['100.125.4.25', '8.8.8.8'] }}"
      register: test_subnet_2

    - name: Create router for test
      openstack.cloud.router:
        cloud: "{{ test_cloud }}"
        name: "{{ router_name }}"
        state: present
        network: admin_external_net
        enable_snat: True
        interfaces:
          - net: "{{ test_network.network.name }}"
            subnet: "{{ test_subnet_1.subnet.name }}"
          - net: "{{ test_network.network.name }}"
            subnet: "{{ test_subnet_2.subnet.name }}"
      register: test_router

    - name: Create vpn service
      opentelekomcloud.cloud.vpn_service:
        router: "{{ router_name }}"
        subnet: "{{ subnet_name_1 }}"
        name_or_id: "{{ vpn_name }}"
      register: test_vpn_1

    - name: assert result
      assert:
        that:
          - test_vpn_1 is success
          - test_vpn_1 is changed
          - test_vpn_1.vpn.id is defined

    - name: Recreate vpn service
      opentelekomcloud.cloud.vpn_service:
        router: "{{ router_name }}"
        subnet: "{{ subnet_name_2 }}"
        name_or_id: "{{ vpn_name }}"
      register: test_vpn_2

    - name: assert result
      assert:
        that:
          - test_vpn_2 is success
          - test_vpn_2 is changed
          - test_vpn_2.vpn.id is defined

    - name: Update vpn service
      opentelekomcloud.cloud.vpn_service:
        router: "{{ router_name }}"
        subnet: "{{ subnet_name_2 }}"
        name_or_id: "{{ vpn_name }}"
        description: "new description"
      register: updated_vpn

    - name: assert result
      assert:
        that:
          - updated_vpn is success
          - updated_vpn is changed
          - updated_vpn.vpn.description is defined

    - name: Delete vpn service
      opentelekomcloud.cloud.vpn_service:
        name_or_id: "{{ vpn_name }}"
        state: "absent"
      register: deleted_vpn

    - name: assert result
      assert:
        that:
          - deleted_vpn is success
          - deleted_vpn is changed

  always:
    - block:
      # Cleanup
      - name: Drop vpn
        opentelekomcloud.cloud.vpn_service:
          name: "{{ vpn_name }}"
          state: "absent"

      - name: Drop router
        openstack.cloud.router:
          cloud: "{{ test_cloud }}"
          name: "{{ router_name }}"
          state: absent

      - name: Drop first subnet
        openstack.cloud.subnet:
          cloud: "{{ test_cloud }}"
          name: "{{ subnet_name_1 }}"
          state: absent

      - name: Drop second subnet
        openstack.cloud.subnet:
          cloud: "{{ test_cloud }}"
          name: "{{ subnet_name_2 }}"
          state: absent

      - name: Drop network
        openstack.cloud.network:
          cloud: "{{ test_cloud }}"
          name: "{{ network_name }}"
          state: absent
      ignore_errors: yes
